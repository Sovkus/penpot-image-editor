<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            padding: 16px;
            background: var(--bg-primary, #ffffff);
            color: var(--text-primary, #000000);
            min-width: 400px;
        }
        
        .header {
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary, #000000);
        }
        
        .header p {
            font-size: 12px;
            color: var(--text-secondary, #666666);
            margin-top: 4px;
        }
        
        .preview-section {
            margin-bottom: 20px;
        }
        
        .preview-container {
            width: 208px;
            height: 208px;
            background: var(--bg-secondary, #f0f0f0);
            border: 1px solid var(--border, #e0e0e0);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }
        
        .no-image {
            color: var(--text-secondary, #666666);
            text-align: center;
            padding: 20px;
            font-size: 14px;
        }
        
        .controls {
            margin-top: 20px;
        }
        
        .control-group {
            margin-bottom: 16px;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .control-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary, #000000);
            text-transform: uppercase;
        }
        
        .control-value {
            font-size: 12px;
            color: var(--text-secondary, #666666);
        }
        
        .slider {
            width: 100%;
            height: 4px;
            background: var(--slider-track, #e0e0e0);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary, #2680eb);
            cursor: pointer;
            border: 2px solid var(--bg-primary, #ffffff);
        }
        
        .buttons {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }
        
        button {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .reset-btn {
            background: var(--bg-secondary, #f0f0f0);
            color: var(--text-primary, #000000);
        }
        
        .apply-btn {
            background: var(--primary, #2680eb);
            color: white;
        }
        
        .apply-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 12px;
            font-size: 12px;
            text-align: center;
            min-height: 20px;
        }
        
        .success {
            color: #10b981;
        }
        
        .error {
            color: #ef4444;
        }
        
        .info {
            color: var(--text-secondary, #666666);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Image Editor</h1>
        <p>Select an image in Penpot to edit colors</p>
    </div>
    
    <div class="preview-section">
        <div class="preview-container" id="previewContainer">
            <img id="previewImage" class="preview-image" alt="Preview">
            <div id="noImage" class="no-image">No image selected</div>
        </div>
    </div>
    
    <div class="controls" id="controls">
        <!-- Controls will be added by JavaScript -->
    </div>
    
    <div class="buttons">
        <button id="resetBtn" class="reset-btn">Reset All</button>
        <button id="applyBtn" class="apply-btn" disabled>Apply Changes</button>
    </div>
    
    <div id="status" class="status info"></div>

    <script>
        // === Image Editor Plugin ===
        console.log("üöÄ Image Editor Plugin Starting...");
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let selectedImage = null;
        let currentFilters = {};
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        let previewImage, noImage, controlsDiv, resetBtn, applyBtn, statusDiv;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª–∑—É–Ω–∫–æ–≤
        const sliderConfigs = [
            { id: 'exposure', label: 'Exposure', min: -100, max: 100, value: 0 },
            { id: 'contrast', label: 'Contrast', min: -100, max: 100, value: 0 },
            { id: 'saturation', label: 'Saturation', min: -100, max: 100, value: 0 },
            { id: 'temperature', label: 'Temperature', min: -100, max: 100, value: 0 },
            { id: 'tint', label: 'Tint', min: -100, max: 100, value: 0 },
            { id: 'highlights', label: 'Highlights', min: -100, max: 100, value: 0 },
            { id: 'shadows', label: 'Shadows', min: -100, max: 100, value: 0 }
        ];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            console.log("üîÑ Initializing plugin...");
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
                previewImage = document.getElementById('previewImage');
                noImage = document.getElementById('noImage');
                controlsDiv = document.getElementById('controls');
                resetBtn = document.getElementById('resetBtn');
                applyBtn = document.getElementById('applyBtn');
                statusDiv = document.getElementById('status');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                if (!previewImage || !controlsDiv) {
                    throw new Error("DOM elements not found");
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                sliderConfigs.forEach(config => {
                    currentFilters[config.id] = config.value;
                });
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∑—É–Ω–∫–∏
                createSliders();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
                setupButtons();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
                updateTheme();
                
                // –°–æ–æ–±—â–∞–µ–º Penpot –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                notifyPenpotReady();
                
                console.log("‚úÖ Plugin initialized successfully");
                showStatus("Ready - select an image in Penpot", "info");
                
            } catch (error) {
                console.error("‚ùå Initialization error:", error);
                showStatus("Error: " + error.message, "error");
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–æ–≤
        function createSliders() {
            sliderConfigs.forEach(config => {
                // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É
                const group = document.createElement('div');
                group.className = 'control-group';
                group.id = `group-${config.id}`;
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                const header = document.createElement('div');
                header.className = 'control-header';
                
                const label = document.createElement('span');
                label.className = 'control-label';
                label.textContent = config.label;
                
                const value = document.createElement('span');
                value.className = 'control-value';
                value.id = `${config.id}Value`;
                value.textContent = '0';
                
                header.appendChild(label);
                header.appendChild(value);
                
                // –ü–æ–ª–∑—É–Ω–æ–∫
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.className = 'slider';
                slider.id = config.id;
                slider.min = config.min;
                slider.max = config.max;
                slider.value = config.value;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫
                slider.addEventListener('input', function(e) {
                    const val = parseInt(e.target.value);
                    currentFilters[config.id] = val;
                    value.textContent = val;
                    updateImagePreview();
                });
                
                // –°–æ–±–∏—Ä–∞–µ–º
                group.appendChild(header);
                group.appendChild(slider);
                controlsDiv.appendChild(group);
            });
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
        function setupButtons() {
            // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
            resetBtn.addEventListener('click', function() {
                resetAllFilters();
                showStatus("All filters reset", "success");
            });
            
            // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
            applyBtn.addEventListener('click', function() {
                applyFiltersToImage();
            });
            
            // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
            applyBtn.disabled = true;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        function updateImagePreview() {
            if (!previewImage || !previewImage.src) return;
            
            const filter = generateFilterCSS();
            previewImage.style.filter = filter;
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSS —Ñ–∏–ª—å—Ç—Ä–∞
        function generateFilterCSS() {
            const filters = [];
            
            // Exposure
            if (currentFilters.exposure !== 0) {
                filters.push(`brightness(${1 + currentFilters.exposure / 100})`);
            }
            
            // Contrast
            if (currentFilters.contrast !== 0) {
                filters.push(`contrast(${1 + currentFilters.contrast / 100})`);
            }
            
            // Saturation
            if (currentFilters.saturation !== 0) {
                filters.push(`saturate(${1 + currentFilters.saturation / 100})`);
            }
            
            // Temperature (—Ç–µ–ø–ª–æ—Ç–∞/—Ö–æ–ª–æ–¥)
            if (currentFilters.temperature !== 0) {
                const temp = currentFilters.temperature / 100;
                if (temp > 0) {
                    filters.push(`sepia(${temp})`);
                }
            }
            
            // Tint (–æ—Ç—Ç–µ–Ω–æ–∫)
            if (currentFilters.tint !== 0) {
                filters.push(`hue-rotate(${currentFilters.tint}deg)`);
            }
            
            return filters.length > 0 ? filters.join(' ') : 'none';
        }
        
        // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetAllFilters() {
            sliderConfigs.forEach(config => {
                currentFilters[config.id] = 0;
                const slider = document.getElementById(config.id);
                const value = document.getElementById(`${config.id}Value`);
                if (slider) slider.value = 0;
                if (value) value.textContent = '0';
            });
            updateImagePreview();
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        function applyFiltersToImage() {
            if (!selectedImage) {
                showStatus("No image selected", "error");
                return;
            }
            
            showStatus("Applying filters...", "info");
            
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Penpot
            setTimeout(() => {
                showStatus("Filters applied successfully!", "success");
            }, 1000);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã
        function updateTheme() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            const root = document.documentElement;
            
            if (isDark) {
                root.style.setProperty('--bg-primary', '#1a1a1a');
                root.style.setProperty('--bg-secondary', '#2d2d2d');
                root.style.setProperty('--text-primary', '#ffffff');
                root.style.setProperty('--text-secondary', '#a0a0a0');
                root.style.setProperty('--border', '#404040');
                root.style.setProperty('--slider-track', '#404040');
                root.style.setProperty('--primary', '#2680eb');
            } else {
                root.style.setProperty('--bg-primary', '#ffffff');
                root.style.setProperty('--bg-secondary', '#f5f5f5');
                root.style.setProperty('--text-primary', '#000000');
                root.style.setProperty('--text-secondary', '#666666');
                root.style.setProperty('--border', '#e0e0e0');
                root.style.setProperty('--slider-track', '#e0e0e0');
                root.style.setProperty('--primary', '#2680eb');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
        function showStatus(message, type = "info") {
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (type === "info") {
                    setTimeout(() => {
                        if (statusDiv.textContent === message) {
                            statusDiv.textContent = "";
                        }
                    }, 3000);
                }
            }
            console.log(`Status [${type}]: ${message}`);
        }
        
        // –£–≤–µ–¥–æ–º–∏—Ç—å Penpot –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        function notifyPenpotReady() {
            setTimeout(() => {
                try {
                    if (window.parent) {
                        window.parent.postMessage({
                            type: 'plugin-ready',
                            source: 'image-editor',
                            version: '1.0.0'
                        }, '*');
                        console.log("üì® Sent ready message to Penpot");
                    }
                } catch (error) {
                    console.error("Error notifying Penpot:", error);
                }
            }, 500);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Penpot
        window.addEventListener('message', function(event) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Penpot
            if (event.source !== window.parent) return;
            
            const data = event.data;
            console.log("üì© Message from Penpot:", data);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤—ã–¥–µ–ª–µ–Ω–∏–∏
            if (data && data.type === 'selection') {
                handleSelection(data.data || data.selection);
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–µ–º–µ
            if (data && data.type === 'theme') {
                updateTheme();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤ Penpot
        function handleSelection(selection) {
            console.log("Selection updated:", selection);
            
            if (!selection || selection.length !== 1) {
                // –ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç–æ–≤
                noImage.style.display = 'block';
                previewImage.style.display = 'none';
                applyBtn.disabled = true;
                selectedImage = null;
                showStatus("Select a single image in Penpot", "info");
                return;
            }
            
            const item = selection[0];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (item.type === 'image' || item.fillType === 'image') {
                selectedImage = item;
                noImage.style.display = 'none';
                previewImage.style.display = 'block';
                applyBtn.disabled = false;
                
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                // –î–ª—è —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
                previewImage.src = 'https://via.placeholder.com/208x208/2680eb/ffffff?text=Image+Selected';
                resetAllFilters();
                
                showStatus("Image selected - adjust colors below", "success");
            } else {
                // –í—ã–¥–µ–ª–µ–Ω –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                noImage.style.display = 'block';
                previewImage.style.display = 'none';
                applyBtn.disabled = true;
                selectedImage = null;
                showStatus("Please select an image (not a shape or text)", "error");
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            init();
        }
        
        console.log("üëå Plugin script loaded");
        
    </script>
</body>
</html>
