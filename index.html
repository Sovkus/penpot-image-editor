<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
        }
        
        body {
            padding: 16px;
            background: var(--background, #FFFFFF);
            color: var(--text-primary, #000000);
            min-width: 400px;
        }
        
        .container {
            display: flex;
            gap: 20px;
        }
        
        .preview-section {
            flex-shrink: 0;
        }
        
        .preview-container {
            width: 208px;
            height: 208px;
            border-radius: 8px;
            background: var(--background-secondary, #F0F0F0);
            border: 1px solid var(--border, #E0E0E0);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }
        
        .no-image {
            color: var(--text-secondary, #666666);
            text-align: center;
            padding: 20px;
        }
        
        .controls-section {
            flex: 1;
        }
        
        .control-group {
            margin-bottom: 16px;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .control-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .control-value {
            font-size: 12px;
            color: var(--text-secondary, #666666);
        }
        
        .slider {
            width: 100%;
            height: 4px;
            background: var(--slider-track, #E0E0E0);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary, #2680EB);
            cursor: pointer;
        }
        
        .buttons {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }
        
        button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .reset-btn {
            background: var(--secondary, #F0F0F0);
            color: var(--text-primary, #000000);
        }
        
        .apply-btn {
            background: var(--primary, #2680EB);
            color: white;
        }
        
        .apply-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .error {
            color: #E5484D;
            font-size: 12px;
            margin-top: 8px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="preview-section">
            <div class="preview-container">
                <img id="previewImage" class="preview-image" alt="Preview">
                <div id="noImage" class="no-image">Select an image in Penpot</div>
            </div>
        </div>
        
        <div class="controls-section">
            <!-- Controls will be added by JavaScript -->
            <div id="controls"></div>
            
            <div class="buttons">
                <button id="resetBtn" class="reset-btn">Reset</button>
                <button id="applyBtn" class="apply-btn" disabled>Apply</button>
            </div>
            
            <div id="error" class="error"></div>
        </div>
    </div>

    <script>
        // ВСЁ В ОДНОМ ФАЙЛЕ - так надежнее для Penpot
        console.log("Plugin script starting...");
        
        // Основные переменные
        let selectedImage = null;
        let currentFilters = {
            exposure: 0,
            contrast: 0,
            saturation: 0,
            temperature: 0,
            tint: 0,
            highlights: 0,
            shadows: 0
        };
        
        // DOM элементы
        let previewImage, noImage, controlsDiv, resetBtn, applyBtn, errorDiv;
        
        // Создаем элементы ПОСЛЕ загрузки
        function initPlugin() {
            console.log("Initializing plugin DOM...");
            
            try {
                // Получаем элементы
                previewImage = document.getElementById('previewImage');
                noImage = document.getElementById('noImage');
                controlsDiv = document.getElementById('controls');
                resetBtn = document.getElementById('resetBtn');
                applyBtn = document.getElementById('applyBtn');
                errorDiv = document.getElementById('error');
                
                // Создаем ползунки
                createSliders();
                
                // Настраиваем кнопки
                if (resetBtn) {
                    resetBtn.addEventListener('click', resetFilters);
                }
                
                if (applyBtn) {
                    applyBtn.addEventListener('click', applyFilters);
                }
                
                // Запрашиваем данные у Penpot
                sendToPenpot('get-selection');
                sendToPenpot('get-theme');
                
                console.log("Plugin initialized successfully");
                
            } catch (err) {
                console.error("Init error:", err);
            }
        }
        
        // Создание ползунков
        function createSliders() {
            if (!controlsDiv) return;
            
            const slidersConfig = [
                { id: 'exposure', label: 'Exposure', min: -100, max: 100, value: 0 },
                { id: 'contrast', label: 'Contrast', min: -100, max: 100, value: 0 },
                { id: 'saturation', label: 'Saturation', min: -100, max: 100, value: 0 },
                { id: 'temperature', label: 'Temperature', min: -100, max: 100, value: 0 },
                { id: 'tint', label: 'Tint', min: -100, max: 100, value: 0 },
                { id: 'highlights', label: 'Highlights', min: -100, max: 100, value: 0 },
                { id: 'shadows', label: 'Shadows', min: -100, max: 100, value: 0 }
            ];
            
            slidersConfig.forEach(config => {
                const group = document.createElement('div');
                group.className = 'control-group';
                
                const header = document.createElement('div');
                header.className = 'control-header';
                
                const label = document.createElement('span');
                label.className = 'control-label';
                label.textContent = config.label;
                
                const value = document.createElement('span');
                value.className = 'control-value';
                value.id = config.id + 'Value';
                value.textContent = '0';
                
                header.appendChild(label);
                header.appendChild(value);
                
                const sliderContainer = document.createElement('div');
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.className = 'slider';
                slider.id = config.id;
                slider.min = config.min;
                slider.max = config.max;
                slider.value = config.value;
                
                slider.addEventListener('input', function(e) {
                    const val = parseInt(e.target.value);
                    currentFilters[config.id] = val;
                    value.textContent = val;
                    updatePreview();
                });
                
                sliderContainer.appendChild(slider);
                group.appendChild(header);
                group.appendChild(sliderContainer);
                controlsDiv.appendChild(group);
            });
        }
        
        // Обновление предпросмотра
        function updatePreview() {
            if (!previewImage || !previewImage.src) return;
            
            const filter = generateFilter();
            previewImage.style.filter = filter;
        }
        
        // Генерация фильтра
        function generateFilter() {
            const f = currentFilters;
            const filters = [];
            
            if (f.exposure !== 0) filters.push(`brightness(${1 + f.exposure/100})`);
            if (f.contrast !== 0) filters.push(`contrast(${1 + f.contrast/100})`);
            if (f.saturation !== 0) filters.push(`saturate(${1 + f.saturation/100})`);
            if (f.temperature !== 0) filters.push(`sepia(${Math.abs(f.temperature)/100})`);
            if (f.tint !== 0) filters.push(`hue-rotate(${f.tint}deg)`);
            
            return filters.join(' ') || 'none';
        }
        
        // Сброс фильтров
        function resetFilters() {
            Object.keys(currentFilters).forEach(key => {
                currentFilters[key] = 0;
                const slider = document.getElementById(key);
                const value = document.getElementById(key + 'Value');
                if (slider) slider.value = 0;
                if (value) value.textContent = '0';
            });
            updatePreview();
        }
        
        // Применение фильтров
        function applyFilters() {
            if (!selectedImage) {
                showError('Select an image first');
                return;
            }
            
            showError('Applying filters...');
            
            // Здесь будет код применения фильтров к изображению
            sendToPenpot('update-image', {
                id: selectedImage.id,
                filters: { ...currentFilters }
            });
        }
        
        // Показать ошибку
        function showError(msg) {
            if (errorDiv) {
                errorDiv.textContent = msg;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
            console.log("Error:", msg);
        }
        
        // Отправка сообщения в Penpot
        function sendToPenpot(type, data = {}) {
            window.parent.postMessage({
                type: type,
                data: data,
                source: 'image-editor-plugin'
            }, '*');
        }
        
        // Обработчик сообщений от Penpot
        window.addEventListener('message', function(event) {
            if (event.source !== window.parent) return;
            
            const msg = event.data;
            console.log("Message from Penpot:", msg);
            
            switch(msg.type) {
                case 'selection':
                    handleSelection(msg.data);
                    break;
                    
                case 'theme':
                    applyTheme(msg.data);
                    break;
                    
                case 'image-data':
                    handleImageData(msg.data);
                    break;
            }
        });
        
        // Обработка выделения
        function handleSelection(selection) {
            console.log("Selection:", selection);
            
            if (!selection || selection.length !== 1) {
                if (noImage) noImage.style.display = 'block';
                if (previewImage) previewImage.style.display = 'none';
                if (applyBtn) applyBtn.disabled = true;
                selectedImage = null;
                return;
            }
            
            const item = selection[0];
            if (item.type === 'image') {
                selectedImage = item;
                if (noImage) noImage.style.display = 'none';
                if (previewImage) previewImage.style.display = 'block';
                if (applyBtn) applyBtn.disabled = false;
                
                // Запрашиваем данные изображения
                sendToPenpot('get-image-data', { id: item.id });
            }
        }
        
        // Обработка данных изображения
        function handleImageData(data) {
            if (data && data.url && previewImage) {
                previewImage.src = data.url;
                resetFilters();
            }
        }
        
        // Применение темы
        function applyTheme(theme) {
            const root = document.documentElement;
            if (!root) return;
            
            const colors = theme === 'dark' ? {
                '--background': '#1F1F1F',
                '--text-primary': '#FFFFFF',
                '--text-secondary': '#A0A0A0',
                '--primary': '#2680EB',
                '--secondary': '#2D2D2D',
                '--border': '#3D3D3D',
                '--slider-track': '#3D3D3D'
            } : {
                '--background': '#FFFFFF',
                '--text-primary': '#000000',
                '--text-secondary': '#666666',
                '--primary': '#2680EB',
                '--secondary': '#F0F0F0',
                '--border': '#E0E0E0',
                '--slider-track': '#E0E0E0'
            };
            
            Object.entries(colors).forEach(([key, value]) => {
                root.style.setProperty(key, value);
            });
            
            // Обновляем фон контейнера
            const container = document.querySelector('.preview-container');
            if (container) {
                container.style.backgroundColor = colors['--secondary'];
                container.style.borderColor = colors['--border'];
            }
        }
        
        // Запускаем инициализацию
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPlugin);
        } else {
            // DOM уже загружен
            initPlugin();
        }
        
        // Также сообщаем Penpot, что плагин готов
        setTimeout(() => {
            sendToPenpot('plugin-ready');
        }, 100);
        
    </script>
</body>
</html>
